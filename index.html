<!DOCTYPE html>
<html>

<script>
    class Date {
        constructor(inDateStr) {
            let theSplittedDate = inDateStr.split('-');
            this.year  = parseInt(theSplittedDate[0]);
            this.month = parseInt(theSplittedDate[1]);
            this.day   = parseInt(theSplittedDate[2]);
        }
    }
    class MonthDay {
        constructor(dateStr) {
            this.month = parseInt(dateStr.split('-')[1])
            this.day = parseInt(dateStr.split('-')[2])
        }
        cmp(other) {
            if (this.month == other.month) {
                if (this.day == other.day) {
                    return 0;
                }
                else if (this.day < other.day) {
                    return -1;
                }
                return +1;
            }
            if ((this.month > 6) && (other.month < 6)) {
                return -1;
            }
            if ((this.month < 6) && (other.month > 6)) {
                return +1;
            }
            return this.month < other.month ? -1 : +1;
        }

    }
    class Winter {
        constructor(inStartYear) {
            let nextYear = inStartYear + 1;
            this.dateList = [];
            this.startYear = inStartYear;
            this.name = inStartYear.toString() + '-' + nextYear.toString();
            this.countNbPellet = 0;
        }
    }

    function genHeaderHtml(winterList) {
        let str  = '<tr>\n';
        str += '<th></th>\n';
        winterList.forEach(function (w) {
            str += '<th>' + w.name + '</th>\n';
        });
        str += '</tr>\n';
        return str;
    }
    function genHeaderTxt(winterList) {
        let str = '';
        str +='      ';
        winterList.forEach(function (w) {
            str += '|' + w.name;
        });
        str += '|\n'
        return str;
    }
    function genHeader(type, winterList) {
        if (type == 0) {
            return genHeaderTxt(winterList);
        }
        else {
            return genHeaderHtml(winterList);
        }
    }

    function genFooterTxt(winterList) {
        let str  = '******' + '**********'.repeat(winterList.length) + '*\n';
        str += 'Total :'
        for (let i=0; i < winterList.length; ++i) {
            str += '    '+ winterList[i].dateList.length.toString().padStart(2, ' ') +'   |';
        }
        return str;
    }
    function genFooterHtml(winterList) {
        let str  = '<tr>';
        str += '<td>Total :</td>'
        for (let i=0; i < winterList.length; ++i) {
            str += '<td>'+ winterList[i].dateList.length.toString() +'</td>';
        }
        str += '</tr>\n';
        return str;
    }
    function genFooter(type, winterList) {
        if (type == 0) {
            return genFooterTxt(winterList);
        }
        else {
            return genFooterHtml(winterList);
        }
    }

    function GetMonthStr(inMonth) {
        let m = {1: 'jan',  2: 'fev',  3: 'mar',  4: 'avr', 5: 'mai',
            9: 'sep', 10: 'oct', 11: 'nov', 12: 'dec'};
        return m[inMonth];
    }
    function genDateColumnTxt(date) {
        return date.day.toString().padStart(2, ' ') + ' ' + GetMonthStr(date.month) + '|';
    }
    function genDateColumnHtml(date) {
        let str  = '<td>';
        str += date.day.toString() + ' ' + GetMonthStr(date.month);
        str += '</td>';
        return str;
    }
    function genDateColumn(type, date) {
        if (type == 0) {
            return genDateColumnTxt(date);
        }
        else {
            return genDateColumnHtml(date);
        }
    }

    function genWinterColumnsTxt(d, winterList) {
        let str = '';
        for (let i=0; i < winterList.length; ++i) {
            let winter = winterList[i];
            if (winter.dateList.find(function(date) { return d.cmp(date) == 0;})) {
                winter.countNbPellet += 1;
                str += '    ' + winter.countNbPellet.toString().padStart(2, ' ') + '   |';
            }
            else {
                str += '         |';
            }
        }
        return str;
    }
    function genWinterColumnsHtml(d, winterList) {
        let str = '';
        for (let i=0; i < winterList.length; ++i) {
            let winter = winterList[i];
            if (winter.dateList.find(function(date) { return d.cmp(date) == 0;})) {
                winter.countNbPellet += 1;
                str += '<td>' + winter.countNbPellet.toString() + '</td>';
            }
            else {
                str += '<td></td>';
            }
        }
        return str;
    }
    function genWinterColumns(type, date, winterList) {
        if (type == 0) {
            return genWinterColumnsTxt(date, winterList);
        }
        else {
            return genWinterColumnsHtml(date, winterList);
        }
    }

    function genRowTxt(d, winterList) {
        let str = '';
        str += genDateColumnTxt(d);
        str += genWinterColumnsTxt(d, winterList);
        str += '\n';
        return str;
    }
    function genRowHtml(d, winterList) {
        let str = '<tr>';
        str += genDateColumnHtml(d);
        str += genWinterColumnsHtml(d, winterList);
        str += '</tr>\n';
        return str;
    }
    function genRow(type, date, winterList) {
        if (type == 0) {
            return genRowTxt(date, winterList);
        }
        else {
            return genRowHtml(date, winterList);
        }
    }

    function genTable(type, sortedDates, winterList) {
        let str = '';

        if (type == 1) {
            str += '<table>\n';
        }

        str += genHeader(type, winterList);

        sortedDates.forEach(function(d) {
            str += genRow(type, d, winterList);
        });
        str += genFooter(type, winterList);

        if (type == 1) {
            str += '</table>\n';
        }
        return str;
    }

    function processData(inData) {
        // code to be executed
        let arr = inData.split("\n");
        let fLen = arr.length;
        let theWinter = null;
        let winterList = [];
        let dateArr = [];

        for (let i = 0; i < fLen-1; i++) {
            let dateStr = arr[i];
            let theDate = new Date(dateStr);

            if ((theWinter == null) || ((theWinter.startYear == theDate.year - 1) && theDate.month > 6)) {
            console.log(theWinter);
                theWinter = new Winter(theDate.year);
                winterList.push(theWinter);
            }
            theMonthDay = new MonthDay(dateStr);
            theWinter.dateList.push(theMonthDay);
            dateArr.push(theMonthDay);
        }
        dateArr.sort(function (a, b) { return a.cmp(b);});
        let sortedDates = [];
        dateArr.forEach(function (value) {
            let push = 1;
            if (sortedDates.length != 0) {
                if (sortedDates[sortedDates.length-1].cmp(value) == 0) {
                    //console.log("same val");
                    //console.log(value);
                    push = 0;
                }
            }
            if (push) {
                sortedDates.push(value);
            }
        });
        console.log("sortedDates");
        console.log(sortedDates);
        let genType = 0;
        let f = genTable(genType, sortedDates, winterList);
        console.log(f);
    }
    console.log("titi")
    window.addEventListener('load', function () {
    var myUrl = 'https://raw.githubusercontent.com/benoitdudu/pellet_stove_control/main/pellet_stove_app/pellet_consumption.txt'


    fetch(myUrl)
      .then(response => response.text())
      .then(data => processData(data));

    });
    console.log("titi2")
</script>

<body>
</body>
</html> 
